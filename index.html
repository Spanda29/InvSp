<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Invoice Entry</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { color: #333; }
label { display: block; margin-top: 10px; font-weight: bold; }
input, select, textarea { padding: 6px; width: 100%; max-width: 400px; margin-top: 4px; box-sizing: border-box; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #f4f4f4; }
button { padding: 8px 12px; margin-top: 15px; background: #007BFF; color: #fff; border: none; cursor: pointer; }
button:hover { background: #0056b3; }
@media screen and (max-width: 768px) {
    body { margin: 10px; }
    table, thead, tbody, th, td, tr { display: block; width: 100%; }
    thead tr { display: none; }
    tr { margin-bottom: 15px; background: #fafafa; padding: 10px; border-radius: 5px; }
    td { border: none; border-bottom: 1px solid #ddd; text-align: right; padding-left: 50%; position: relative; }
    td::before { position: absolute; left: 10px; width: 45%; white-space: nowrap; text-align: left; font-weight: bold; }
    td:nth-of-type(1)::before { content: "Item Name"; }
    td:nth-of-type(2)::before { content: "PCs"; }
    td:nth-of-type(3)::before { content: "Rate"; }
    td:nth-of-type(4)::before { content: "Total"; }
    td:nth-of-type(5)::before { content: "Action"; }
}
</style>
</head>
<body>

<h1>Invoice Entry</h1>
<form id="invoiceForm">
    <label>Invoice No:</label>
    <input type="text" id="invoiceNo" required>
    <label>Date:</label>
    <input type="date" id="invoiceDate" required>
    <label>Party Name:</label>
    <input type="text" id="partyName" placeholder="Enter Party Name" required>
    <label>Narration:</label>
    <textarea id="narration"></textarea>

    <h3>Items</h3>
    <table id="itemsTable">
        <thead>
            <tr>
                <th>Item Name</th>
                <th>PCs</th>
                <th>Rate</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <select class="itemName" onchange="updateRate(this)" required>
                        <option value="">--Select Item--</option>
                    </select>
                </td>
                <td><input type="number" class="pcs" min="1" value="1"></td>
                <td><input type="number" class="rate" min="0" step="0.01" value="0.00"></td>
                <td class="lineTotal">0.00</td>
                <td><button type="button" onclick="removeRow(this)">Remove</button></td>
            </tr>
        </tbody>
    </table>

    <button type="button" onclick="addRow()">+ Add Item</button>
    <h3>Grand Total: <span id="grandTotal">0.00</span></h3>
    <button type="submit">Save Invoice</button>
</form>

<script>
let itemsList = [];

async function loadRateList() {
    try {
        const response = await fetch("ratelist.json"); // Same repo & folder
        itemsList = await response.json();
        populateItemDropdown(document.querySelector(".itemName"));
    } catch (err) {
        console.error("Error loading rate list:", err);
        alert("Failed to load rate list. Make sure ratelist.json is in the repo.");
    }
}

function populateItemDropdown(selectElement) {
    selectElement.innerHTML = '<option value="">--Select Item--</option>';
    itemsList.forEach(item => {
        let opt = document.createElement("option");
        opt.value = item.ItemName;
        opt.textContent = item.ItemName;
        opt.dataset.rate = item.Rate;
        selectElement.appendChild(opt);
    });
}

function updateRate(selectElement) {
    const rateField = selectElement.closest("tr").querySelector(".rate");
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    rateField.value = selectedOption.dataset.rate || 0;
    updateTotals();
}

function updateTotals() {
    let grandTotal = 0;
    document.querySelectorAll("#itemsTable tbody tr").forEach(row => {
        const pcs = parseFloat(row.querySelector(".pcs").value) || 0;
        const rate = parseFloat(row.querySelector(".rate").value) || 0;
        const total = pcs * rate;
        row.querySelector(".lineTotal").textContent = total.toFixed(2);
        grandTotal += total;
    });
    document.getElementById("grandTotal").textContent = grandTotal.toFixed(2);
}

function addRow() {
    const tbody = document.querySelector("#itemsTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td><select class="itemName" onchange="updateRate(this)" required></select></td>
        <td><input type="number" class="pcs" min="1" value="1"></td>
        <td><input type="number" class="rate" min="0" step="0.01" value="0.00"></td>
        <td class="lineTotal">0.00</td>
        <td><button type="button" onclick="removeRow(this)">Remove</button></td>
    `;
    tbody.appendChild(tr);
    populateItemDropdown(tr.querySelector(".itemName"));
    addListeners(tr);
}

function removeRow(btn) {
    btn.closest("tr").remove();
    updateTotals();
}

function addListeners(row) {
    row.querySelectorAll(".pcs, .rate").forEach(input => {
        input.addEventListener("input", updateTotals);
    });
}

document.querySelectorAll("#itemsTable tbody tr").forEach(addListeners);

document.getElementById("invoiceForm").addEventListener("submit", e => {
    e.preventDefault();
    alert("Invoice Saved!");
});

loadRateList();
</script>

</body>
</html>
