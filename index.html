<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Invoice Entry</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #e0f7fa, #fce4ec);
        margin: 0; padding: 0;
    }
    .container {
        max-width: 1100px;
        margin: auto;
        background: white;
        padding: 20px;
        margin-top: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        animation: fadeIn 0.8s ease-out;
    }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    h1 { text-align: center; color: #673ab7; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, textarea {
        width: 100%; padding: 8px; margin-top: 5px;
        border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #673ab7; color: white; }
    button {
        padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer;
    }
    .btn-primary { background: #4cafef; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .autocomplete-suggestions {
        border: 1px solid #ccc; background: white;
        position: absolute; max-height: 150px;
        overflow-y: auto; z-index: 1000;
        width: calc(100% - 20px);
    }
    .autocomplete-suggestions div {
        padding: 5px; cursor: pointer;
    }
    .autocomplete-suggestions div:hover { background: #f1f1f1; }
    @media (max-width:768px){
        table, thead, tbody, th, td, tr { display:block; }
        thead tr { display:none; }
        td { position:relative; padding-left:50%; }
        td::before { position:absolute; left:10px; font-weight:bold; }
        td:nth-of-type(1)::before { content:"Item Name"; }
        td:nth-of-type(2)::before { content:"Qty"; }
        td:nth-of-type(3)::before { content:"Rate"; }
        td:nth-of-type(4)::before { content:"Total"; }
        td:nth-of-type(5)::before { content:"Action"; }
    }
</style>
</head>
<body>
<div class="container">
    <h1>Invoice</h1>
    <form id="invoiceForm">
        <label>Invoice No:</label>
        <input type="text" id="invoiceNo" required>
        <label>Date:</label>
        <input type="date" id="invoiceDate" required>
        <label>Party Name:</label>
        <input type="text" id="partyName" required>
        <label>Narration:</label>
        <textarea id="narration"></textarea>

        <h3>Items</h3>
        <table id="itemsTable">
            <thead>
                <tr>
                    <th>Item Name</th><th>Qty</th><th>Rate</th><th>Total</th><th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button type="button" class="btn-primary" onclick="addRow()">+ Add Item</button>
        <br><br>
        <label>Discount:</label>
        <input type="number" id="discount" value="0" step="0.01" oninput="updateTotals()"/>
        <h3>Grand Total: <span id="grandTotal">0.00</span></h3>
        <button type="submit" class="btn-primary">Save Invoice</button>
    </form>
</div>

<script>
let itemsList = [];
const jsonURL = "ratelist.json"; // Must be in same folder on GitHub Pages
const sheetURL = "https://script.google.com/macros/s/AKfycbxUHzN_urJU39R7G0x9WAVZ5LchScoSeHhHEmouhhCUPj0pQ3V-4KW71g-caNx4soCu/exec"; // Replace with Web App URL

async function loadRateList(){
    const res = await fetch(jsonURL);
    const json = await res.json();
    const arr = Array.isArray(json) ? json : (json.data || []);
    itemsList = arr.map(it => ({
        name: it["Item Details"],
        rate: it["Price/Unit"],
        unit: it["Unit"]
    }));
}

function createAutocomplete(input){
    let suggestionBox;
    input.addEventListener("input", function(){
        closeSuggest();
        let val = this.value.trim().toLowerCase();
        if(!val) return;
        suggestionBox = document.createElement("div");
        suggestionBox.classList.add("autocomplete-suggestions");
        this.parentNode.appendChild(suggestionBox);
        itemsList.filter(it => it.name.toLowerCase().includes(val))
        .forEach(it => {
            const div = document.createElement("div");
            div.textContent = `${it.name} (${it.unit})`;
            div.onclick = () => {
                input.value = it.name;
                input.closest("tr").querySelector(".rate").value = it.rate;
                updateTotals();
                closeSuggest();
            };
            suggestionBox.appendChild(div);
        });
    });
    document.addEventListener("click", function(e){
        if(e.target !== input) closeSuggest();
    });
    function closeSuggest(){
        if(suggestionBox) suggestionBox.remove();
    }
}

function addRow(name="", qty=1, rate=0){
    const tbody = document.querySelector("#itemsTable tbody");
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td><input type="text" class="itemName" value="${name}"></td>
        <td><input type="number" class="pcs" min="1" value="${qty}"></td>
        <td><input type="number" class="rate" min="0" step="0.01" value="${rate}"></td>
        <td class="lineTotal">0.00</td>
        <td><button type="button" class="btn-danger" onclick="removeRow(this)">Remove</button></td>
    `;
    tbody.appendChild(tr);
    addListeners(tr);
    createAutocomplete(tr.querySelector(".itemName"));
    updateTotals();
}

function removeRow(btn){
    btn.closest("tr").remove();
    updateTotals();
}

function addListeners(row){
    row.querySelectorAll(".pcs, .rate").forEach(inp=>{
        inp.addEventListener("input", updateTotals);
    });
}

function updateTotals(){
    let grandTotal = 0;
    document.querySelectorAll("#itemsTable tbody tr").forEach(tr=>{
        const pcs = parseFloat(tr.querySelector(".pcs").value) || 0;
        const rate = parseFloat(tr.querySelector(".rate").value) || 0;
        const total = pcs * rate;
        tr.querySelector(".lineTotal").textContent = total.toFixed(2);
        grandTotal += total;
    });
    const discount = parseFloat(document.getElementById("discount").value) || 0;
    document.getElementById("grandTotal").textContent = (grandTotal - discount).toFixed(2);
}

document.getElementById("invoiceForm").addEventListener("submit", e=>{
    e.preventDefault();
    const invoiceData = {
        invoiceNo: document.getElementById("invoiceNo").value,
        date: document.getElementById("invoiceDate").value,
        partyName: document.getElementById("partyName").value,
        narration: document.getElementById("narration").value,
        discount: parseFloat(document.getElementById("discount").value) || 0,
        total: parseFloat(document.getElementById("grandTotal").textContent),
        items: []
    };
    document.querySelectorAll("#itemsTable tbody tr").forEach(row=>{
        const itemName = row.querySelector(".itemName").value;
        const pcs = parseFloat(row.querySelector(".pcs").value) || 0;
        const rate = parseFloat(row.querySelector(".rate").value) || 0;
        const total = pcs * rate;
        invoiceData.items.push({ itemName, pcs, rate, total });
    });

    fetch(sheetURL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(invoiceData)
    })
    .then(res => res.json())
    .then(result => {
        if(result.status === "success"){
            if(confirm("Invoice saved! Do you want to print or download PDF?")){
                window.print();
            }
        } else {
            alert("Save failed: " + result.message);
        }
    })
    .catch(err => alert("Error: " + err.message));
});

// Auto invoice no & date
window.addEventListener("DOMContentLoaded", async ()=>{
    document.getElementById("invoiceNo").value = "INV-" + Date.now();
    document.getElementById("invoiceDate").valueAsDate = new Date();
    await loadRateList();
    addRow();
});
</script>
</body>
</html>
